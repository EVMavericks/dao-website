name: archive-reddit-data

on:
  push:
  # schedule:
  #   - cron: "0 14 * * * " # every day at 2p.m

permissions:
  contents: write

jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        with:
          node-version: "16.x"
          cache: "npm"
          ref: data
      - shell: bash
        run: |
          sudo apt-get update; sudo apt-get install jq -y
          curl -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36' \
            -X GET "https://www.reddit.com/r/ethfinance.json" -o reddit/ethfinance/$(date -u +"%Y%m%d")_posts.json
          DAILY_PERMALINK=$(cat reddit/ethfinance/$(date -u +"%Y%m%d")_posts.json | jq -r '.data.children | map(select(.data.title | test("Daily General Discussion"))) | nth(0) | .data.permalink')
          curl -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36' \
            -X GET "https://www.reddit.com${DAILY_PERMALINK}.json" -o reddit/ethfinance/$(date -u +"%Y%m%d")_daily.json
          cat reddit/ethfinance/$(date -u +"%Y%m%d")_daily.json | jq '.[-1].data.children | map(select(.data.author == "Tricky_Troll") | select(.data.body | test("Daily Doots"))) | first | .data.body' > $(date -u +"%Y%m%d")_daily_doots.json
          YESTERDAY_DAILY_PERMALINK=$(cat reddit/ethfinance/$(date -u +"%Y%m%d")_posts.json | jq -r '.data.children | map(select(.data.title | test("Daily General Discussion"))) | nth(1) | .data.permalink')
          curl -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36' \
            -X GET "https://www.reddit.com${YESTERDAY_DAILY_PERMALINK}.json" -o reddit/ethfinance/$(date -u +"%Y%m%d")_yesterday_daily.json
          git config --global user.name "RisingPaw"
          git config --global user.email "RisingPaw@users.noreply.github.com"
          git add reddit/ethfinance/*.json
          git commit -m "chore(cron): daily fetch of reddit posts from r/ethfinance"
          git push
